# Production environment overrides
global:
  domain: docutag.io
  imageRegistry: ghcr.io/docutag
  # imageVersion: Set automatically by Pulumi deployment (e.g., "1.0.0")
  # Do not hardcode - version is managed via Pulumi config
  imagePullPolicy: IfNotPresent
  storageClass: do-block-storage

controller:
  replicaCount: 3
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 15
    targetCPUUtilizationPercentage: 60
  resources:
    requests:
      memory: "64Mi"
      cpu: "100m"
    limits:
      memory: "100Mi"
      cpu: "250m"
  env:
    generateMockData: false
    workerConcurrency: 20

scraper:
  replicaCount: 2
  persistence:
    size: 100Gi
  resources:
    requests:
      memory: "64Mi"
      cpu: "100m"
    limits:
      memory: "100Mi"
      cpu: "250m"

textanalyzer:
  replicaCount: 3
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 12
    targetCPUUtilizationPercentage: 60
  resources:
    requests:
      memory: "64Mi"
      cpu: "100m"
    limits:
      memory: "100Mi"
      cpu: "250m"
  env:
    ollamaModel: "gemma3:12b"
    workerConcurrency: 10

scheduler:
  replicaCount: 2
  resources:
    requests:
      memory: "64Mi"
      cpu: "100m"
    limits:
      memory: "100Mi"
      cpu: "250m"
  env:
    defaultSchedule: "0 0 * * *"

web:
  replicaCount: 3
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 8
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "250m"

redis:
  global:
    imageRegistry: ""  # Override global registry to use default docker.io
  image:
    registry: docker.io
    repository: bitnami/redis
  master:
    persistence:
      size: 20Gi
    resources:
      requests:
        memory: "250Mi"
        cpu: "250m"
      limits:
        memory: "500Mi"
        cpu: "500m"

# Self-hosted PostgreSQL with HA (saves ~$240/month vs managed)
# Passwords are automatically generated and managed by Pulumi (stored encrypted in Pulumi state)
# Do not set passwords here - they will be overridden by Pulumi deployment
postgresql:
  enabled: true
  global:
    imageRegistry: ""  # Override global registry to use default docker.io
  image:
    registry: docker.io
    repository: bitnami/postgresql
  architecture: replication  # Primary + read replica for HA
  auth:
    database: docutag
    username: docutag
    # password: Set automatically by Pulumi with secure random generation
    # replicationPassword: Set automatically by Pulumi with secure random generation

  # PostgreSQL configuration tuned for 500MB memory footprint
  postgresqlConfiguration:
    shared_buffers: "128MB"              # 25% of memory (500MB * 0.25)
    effective_cache_size: "384MB"        # 75% of memory (500MB * 0.75)
    maintenance_work_mem: "64MB"         # For VACUUM, CREATE INDEX
    work_mem: "16MB"                     # Per-operation memory
    max_connections: "100"               # Reduced for lower memory
    wal_buffers: "4MB"                   # WAL buffer size
    checkpoint_completion_target: "0.9"  # Spread checkpoints
    random_page_cost: "1.1"              # SSD optimization
    effective_io_concurrency: "200"      # SSD parallelism
    max_wal_size: "1GB"                  # WAL size before checkpoint
    min_wal_size: "256MB"                # Minimum WAL size

  primary:
    persistence:
      size: 100Gi
    resources:
      requests:
        memory: "500Mi"
        cpu: "250m"
      limits:
        memory: "500Mi"
        cpu: "500m"

  readReplicas:
    replicaCount: 1
    persistence:
      size: 100Gi
    resources:
      requests:
        memory: "500Mi"
        cpu: "250m"
      limits:
        memory: "500Mi"
        cpu: "500m"

# Use external managed DB if preferred (disable postgresql above)
externalDatabase:
  enabled: false
  host: ""  # Set via --set or secret
  port: 25060
  database: docutag
  username: doadmin
  password: ""  # Set via --set or secret

observability:
  enabled: true
  prometheus:
    persistence:
      size: 100Gi
    retention: 90d
    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "1000m"
  grafana:
    persistence:
      size: 20Gi
    env:
      authAnonymousEnabled: false
      authDisableLoginForm: false
    adminPassword: ""  # Set via --set or secret
    resources:
      requests:
        memory: "128Mi"
        cpu: "200m"
      limits:
        memory: "128Mi"
        cpu: "400m"
  loki:
    persistence:
      size: 100Gi
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "400m"
  tempo:
    persistence:
      size: 50Gi
    resources:
      requests:
        memory: "512Mi"
        cpu: "200m"
      limits:
        memory: "1Gi"
        cpu: "400m"

ingress:
  enabled: true
  tls:
    enabled: true
    certResolver: letsencrypt

# Progressive delivery with Flagger
# NOTE: Disabled until infrastructure workflow deploys Flagger CRDs
flagger:
  enabled: false  # Enable after infrastructure deployment
  strategy: canary  # Gradual rollout
  analysis:
    interval: 1m
    threshold: 5
    stepWeight: 10  # 10% traffic per step
    iterations: 10  # 10 minutes total rollout
  metrics:
    requestSuccessRate:
      enabled: true
      threshold: 99  # 99% success rate required
    requestDuration:
      enabled: true
      threshold: 500  # p99 latency < 500ms
  webhooks:
    helmTests:
      enabled: true
      timeout: 3m
  alerts:
    slack:
      enabled: false  # Set to true and configure webhookUrl if desired
      webhookUrl: ""  # Set via --set or secret
      channel: "#deployments"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - docutag
        topologyKey: kubernetes.io/hostname
