{{- if .Values.controller.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "docutag.fullname" . }}-test-api
  labels:
    {{- include "docutag.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: curlimages/curl:latest
    command:
      - sh
      - -c
      - |
        set -e
        echo "Testing controller API endpoints..."

        BASE_URL="http://{{ include "docutag.fullname" . }}-controller:8080"

        # Wait for service to be ready
        echo "Waiting for controller service to be ready..."
        sleep 5

        # Test health endpoint
        echo "→ Testing /health endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL/health)
        if [ "$response" != "200" ]; then
          echo "✗ Health endpoint failed (HTTP $response)"
          exit 1
        fi
        echo "  ✓ Health endpoint OK"

        # Test metrics endpoint
        echo "→ Testing /metrics endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL/metrics)
        if [ "$response" != "200" ]; then
          echo "✗ Metrics endpoint failed (HTTP $response)"
          exit 1
        fi
        echo "  ✓ Metrics endpoint OK"

        # Test API requests endpoint with retry logic (wait for migrations)
        echo "→ Testing /api/requests endpoint..."
        MAX_RETRIES=12
        RETRY_DELAY=5
        attempt=1

        while [ $attempt -le $MAX_RETRIES ]; do
          response=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/api/requests")

          if [ "$response" = "200" ]; then
            echo "  ✓ Requests API endpoint OK"
            break
          elif [ $attempt -eq $MAX_RETRIES ]; then
            echo "✗ Requests API endpoint failed after $MAX_RETRIES attempts (HTTP $response)"
            echo "  This likely means database migrations haven't completed yet"
            exit 1
          else
            echo "  Attempt $attempt/$MAX_RETRIES failed (HTTP $response), retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            attempt=$((attempt + 1))
          fi
        done

        echo ""
        echo "✓ All API endpoint tests passed"
        exit 0
{{- end }}
